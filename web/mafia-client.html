<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mafia Online â€” Web Client (WOW)</title>
  <style>
    /* ====== THEME ====== */
    :root{
      --bg:#05070b;
      --fg:#e8eef2;
      --muted:#9aa4ad;
      --border:#1d2633;
      --chip:#0f1729;
      --brand:#7dd3fc;
      --brand-2:#22d3ee;
      --ok:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;
      --panel: #0c1120cc;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --glass: saturate(1.3) blur(10px);
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#edf2f8; --fg:#0e141b; --muted:#516170; --border:#d8e0e7; --chip:#eef3f9; --panel:#ffffffcc;
        --shadow: 0 20px 50px rgba(0,0,0,.10);
      }
    }

    /* ====== RESET ====== */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; color:var(--fg); font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,"Apple Color Emoji","Segoe UI Emoji";}
    .hidden{display:none !important;}

    /* ====== BACKGROUND WOW ====== */
    body::before, body::after{
      content:""; position:fixed; inset:0; pointer-events:none; z-index:-2;
      background:radial-gradient(900px 500px at 100% -10%, rgba(14,165,233,.35), transparent 60%),
                 radial-gradient(800px 400px at -10% 110%, rgba(34,211,238,.33), transparent 55%),
                 linear-gradient(180deg, rgba(2,6,23,1) 0%, rgba(2,8,23,1) 60%, var(--bg) 100%);
    }
    body::after{
      z-index:-1;
      background:conic-gradient(from 0deg at 70% 30%, rgba(125,211,252,.06), rgba(34,211,238,.02), rgba(15,23,42,.0) 60%);
      mix-blend-mode:screen; animation: swirl 18s linear infinite;
    }
    @keyframes swirl{to{transform:rotate(360deg)}}

    /* ====== LAYOUT ====== */
    .container{max-width:1280px; margin:24px auto; padding:0 16px; display:grid; grid-template-columns:1.2fr .8fr; gap:16px}
    @media (max-width:1000px){.container{grid-template-columns:1fr}}

    .card{background:var(--panel); border:1px solid var(--border); border-radius:20px; box-shadow:var(--shadow); overflow:hidden; backdrop-filter:var(--glass)}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

    header.card{
      grid-column:1/-1; padding:14px 16px; display:flex; gap:12px; align-items:center; position:relative;
    }
    header .brand{display:flex; gap:10px; align-items:center; font-weight:900; letter-spacing:.3px}
    .brand-icon{width:28px; height:28px; border-radius:10px; background:linear-gradient(135deg,var(--brand),var(--brand-2)); box-shadow:0 8px 18px rgba(34,211,238,.35)}
    .pill{padding:8px 10px; border-radius:999px; background:var(--chip); border:1px solid var(--border); color:var(--muted); display:inline-flex; gap:8px; align-items:center}
    .pill.ok{color:#1a2; border-color:#1a2a1f; background:rgba(34,197,94,.12)}
    .pill.bad{color:#a21; border-color:#2a1a1f; background:rgba(239,68,68,.12)}
    .grow{flex:1}
    input,select,button,textarea{border-radius:12px; border:1px solid var(--border); padding:10px 12px; background:rgba(255,255,255,.02); color:var(--fg); outline:none; transition:.2s border-color ease, .2s transform ease; font:inherit}
    input::placeholder, textarea::placeholder{color:var(--muted)}
    input:focus,textarea:focus,select:focus{border-color:#38bdf8}
    button{cursor:pointer}
    .btn{background:linear-gradient(135deg,#0ea5e9,#22d3ee); color:#031016; font-weight:800; border-color:#0ea5e9}
    .btn:hover{transform:translateY(-1px)}
    .btn.ghost{background:var(--chip); color:var(--fg)}
    .btn.warn{background:#f59e0b; border-color:#b45309; color:#2b1600}
    .btn.danger{background:#ef4444; border-color:#991b1b; color:#2b0a0a}
    .btn-primary{background:linear-gradient(135deg,#22c55e,#16a34a); border-color:#16a34a; color:#052012}

    /* ====== PANELS ====== */
    .left{display:flex; flex-direction:column; gap:14px}
    .right{display:flex; flex-direction:column; gap:14px}

    /* Auth Card */
    .auth{padding:16px}
    .auth .title{font-weight:900; letter-spacing:.4px; margin-bottom:8px}

    /* Chat Card */
    .chat{display:grid; grid-template-rows:1fr auto}
    .log{padding:14px; max-height:56vh; overflow:auto}
    .log .msg{padding:10px 12px; border-radius:14px; margin:8px 0; border:1px solid var(--border); background:rgba(255,255,255,.03); animation: pop .2s ease}
    .log .me{border-color:#10b98166; background:rgba(16,185,129,.1)}
    .log .sys{border-style:dashed; opacity:.95}
    .log .ok{border-color:#22c55e66; background:rgba(34,197,94,.1)}
    .log .err{border-color:#ef444466; background:rgba(239,68,68,.1)}
    @keyframes pop{from{transform:translateY(4px); opacity:0} to{transform:none; opacity:1}}
    .composer{display:flex; gap:10px; padding:12px; border-top:1px solid var(--border)}
    .composer input{flex:1}

    /* Players */
    .panel{padding:14px}
    .section-title{margin:0 0 8px 0; font-weight:900}
    .players{display:grid; gap:12px; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); max-height:56vh; overflow:auto}

    .player{position:relative; border:1px solid var(--border); padding:12px; border-radius:16px; background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.015)); transition: transform .15s ease, box-shadow .2s ease}
    .player:hover{transform:translateY(-3px); box-shadow:0 20px 40px rgba(0,0,0,.25)}
    .player.dead{opacity:.6; filter:grayscale(.2)}
    .player .hdr{display:flex; align-items:center; gap:10px}
    .avatar{width:42px; height:42px; border-radius:14px; background:linear-gradient(135deg,#38bdf8,#14b8a6); display:grid; place-items:center; color:#031016; font-weight:900; border:1px solid #0ea5e955}
    .meta{display:flex; flex-direction:column; gap:4px; flex:1}
    .name{font-weight:800}
    .status{font-size:12px; color:var(--muted)}
    .badge{padding:4px 8px; border-radius:999px; font-size:12px; font-weight:800; border:1px solid var(--border); background:var(--chip); color:var(--fg); display:inline-flex; gap:6px; align-items:center; white-space:nowrap}
    .badge svg{width:14px; height:14px}

    .role-MAFIA{background:rgba(239,68,68,.12); border-color:#7f1d1d; color:#fecaca}
    .role-DOCTOR{background:rgba(34,197,94,.12); border-color:#14532d; color:#bbf7d0}
    .role-DETECTIVE{background:rgba(59,130,246,.12); border-color:#1e3a8a; color:#bfdbfe}
    .role-BODYGUARD{background:rgba(99,102,241,.12); border-color:#3730a3; color:#c7d2fe}
    .role-JESTER{background:rgba(245,158,11,.12); border-color:#7c2d12; color:#fde68a}
    .role-VILLAGER{background:rgba(14,165,233,.12); border-color:#075985; color:#bae6fd}
    .role-UNASSIGNED{background:rgba(148,163,184,.15); border-color:#334155; color:#e2e8f0}

    /* Controls */
    .controls .row{display:flex; gap:8px; flex-wrap:wrap}
    .controls .row > *{flex:1 1 140px}
    .small{font-size:12px; color:var(--muted)}
    .sep{height:1px; background:var(--border); margin:12px 0}

    /* Toasts */
    .toasts{position:fixed; right:20px; bottom:20px; display:grid; gap:10px; z-index:50}
    .toast{background:var(--panel); border:1px solid var(--border); padding:10px 12px; border-radius:12px; box-shadow:var(--shadow); animation: slideIn .25s ease}
    @keyframes slideIn{from{transform:translateY(8px); opacity:0} to{transform:none; opacity:1}}

    /* Phase Banner */
    .phaseBanner{position:fixed; top:20px; left:50%; transform:translateX(-50%); background:linear-gradient(135deg,#0ea5e9,#22d3ee); color:#031016; border-radius:999px; padding:8px 14px; font-weight:900; letter-spacing:.3px; box-shadow:0 10px 30px rgba(34,211,238,.4); z-index:40; animation: fadeUp .6s ease}
    @keyframes fadeUp{from{transform:translate(-50%, -6px); opacity:0} to{transform:translate(-50%,0); opacity:1}}

    /* Confetti */
    .confetti{position:fixed; top:0; left:0; right:0; bottom:0; pointer-events:none; z-index:30}
    .confetti span{position:absolute; font-size:18px; animation: fall 1200ms linear forwards}
    @keyframes fall{to{transform:translateY(100vh) rotate(480deg); opacity:0}}
  </style>
</head>
<body>
  <!-- Confetti Layer -->
  <div id="confetti" class="confetti" aria-hidden="true"></div>
  <!-- Toasts -->
  <div id="toasts" class="toasts"></div>

  <div class="container">
    <header class="card">
      <div class="brand"><div class="brand-icon"></div><div>Mafia Online</div></div>
      <div id="phasePill" class="pill">PHASE: LOBBY</div>
      <div class="pill">Báº¡n: <strong id="youName" style="margin-left:6px">â€”</strong>&nbsp;<span id="youRole" class="badge role-UNASSIGNED" style="margin-left:8px">â“ UNASSIGNED</span></div>
      <div class="grow"></div>
      <input id="gw" placeholder="ws://localhost:8080/ws" value="ws://localhost:8080/ws"/>
      <button class="btn" id="btnConnect">Káº¿t ná»‘i</button>
      <div id="conn" class="pill bad">Disconnected</div>
    </header>

    <!-- LEFT side -->
    <section class="left">
      <!-- AUTH -->
      <div class="card auth" id="authCard">
        <div class="title">ğŸ” ÄÄƒng kÃ½ & ÄÄƒng nháº­p</div>
        <div class="row">
          <input id="regUser" placeholder="TÃªn Ä‘Äƒng kÃ½ (vd. alice)" />
          <input id="regPass" placeholder="Máº­t kháº©u" type="password" />
          <button class="btn" id="btnRegisterLogin">ÄÄƒng kÃ½ & ÄÄƒng nháº­p</button>
          <button class="btn ghost" id="btnOnlyLogin">Chá»‰ ÄÄƒng nháº­p</button>
        </div>
        <div class="small" style="margin-top:6px">LÆ°u Ã½: máº­t kháº©u gá»­i plaintext trong LAN â€¢ CÃ³ thá»ƒ gÃµ lá»‡nh trá»±c tiáº¿p: <code>/register</code>, <code>/login</code> trong chat</div>
      </div>

      <!-- CHAT -->
      <div class="card chat">
        <div id="log" class="log"></div>
        <div class="composer">
          <input id="msg" placeholder="GÃµ tin nháº¯n hoáº·c /lá»‡nh (vÃ­ dá»¥: /vote bob)"/>
          <button class="btn" id="btnSend">Gá»­i</button>
        </div>
      </div>
    </section>

    <!-- RIGHT side -->
    <aside class="right">
      <div class="card panel">
        <div class="section-title">ğŸ‘¥ NgÆ°á»i chÆ¡i</div>
        <div id="players" class="players"></div>
      </div>

      <div class="card panel controls">
        <div class="section-title">ğŸ› ï¸ Äiá»u khiá»ƒn nhanh</div>
        <div class="row" style="margin-bottom:10px">
          <select id="voteTarget"></select>
          <button class="btn" id="btnVote">Vote</button>
          <button id="btnRematch" class="btn-primary hidden">ğŸ” Báº¯t Ä‘áº§u vÃ¡n má»›i</button>
          <button class="btn ghost" id="btnStart">Start</button>
          <button class="btn ghost" id="btnDay">Day</button>
          <button class="btn ghost" id="btnNight">Night</button>
          <button class="btn warn" id="btnEndDay">End Day</button>
          <button class="btn warn" id="btnEndNight">End Night</button>
        </div>
        <div class="sep"></div>
        <div class="row">
          <input id="roleTarget" placeholder="TÃªn má»¥c tiÃªu theo vai (kill/save/...)"/>
          <button class="btn danger" id="btnRoleAction">Thá»±c hiá»‡n</button>
        </div>
        <div class="small" style="margin-top:6px">Mafia: <code>/kill tÃªn</code> â€¢ Doctor: <code>/save tÃªn</code> â€¢ Detective: <code>/investigate tÃªn</code> â€¢ Bodyguard: <code>/protect tÃªn</code></div>
      </div>
    </aside>
  </div>

  <script>
    // ======== State & Elements ========
    let ws = null; let me = null; let authed = false; let myRole = 'UNASSIGNED';
    const players = new Map(); // name -> {alive:true/false, role:null|'MAFIA'...}

    const $ = id => document.getElementById(id);
    const logEl = $('log'), playersEl = $('players');
    const phasePill = $('phasePill'), youName = $('youName'), youRole = $('youRole');

    const ROLE_ICON = { MAFIA:'ğŸ•´ï¸', DOCTOR:'ğŸ©º', DETECTIVE:'ğŸ•µï¸â€â™‚ï¸', BODYGUARD:'ğŸ›¡ï¸', JESTER:'ğŸ¤¡', VILLAGER:'ğŸ§‘â€ğŸŒ¾', UNASSIGNED:'â“' };

    // ======== UI Utilities ========
    function addMsg(text, cls=''){
      const div = document.createElement('div');
      div.className = 'msg ' + cls; div.textContent = text;
      logEl.appendChild(div); logEl.scrollTop = logEl.scrollHeight;
    }
    function setConn(ok){ const c = $('conn'); c.textContent = ok? 'Connected':'Disconnected'; c.className = 'pill ' + (ok?'ok':'bad'); }
    function setPhase(phase){
      phasePill.textContent = 'PHASE: ' + phase; banner(`PHASE: ${phase}`);
      const rem = $('btnRematch');
      if (phase==='END' || phase==='LOBBY') rem.classList.remove('hidden'); else rem.classList.add('hidden');
      // Reset role sá»›m á»Ÿ LOBBY/DAY Ä‘á»ƒ trÃ¡nh leak
      if (phase==='LOBBY' || phase==='DAY') clearRoles(true);
    }
    function setYou(name){ youName.textContent = name||'â€”'; }
    function setRoleBadge(role){ myRole = role||'UNASSIGNED'; youRole.className = 'badge role-'+myRole; youRole.textContent = `${ROLE_ICON[myRole]||'â“'} ${myRole}`; }

    function initials(name){ const p=(name||'').split(/\s+/).filter(Boolean); return (p[0]?.[0]||'?').toUpperCase() + (p[1]?.[0]||''); }

    function toast(text, ms=2200){ const t=document.createElement('div'); t.className='toast'; t.textContent=text; $('toasts').appendChild(t); setTimeout(()=>t.remove(), ms); }
    function banner(text){ const b=document.createElement('div'); b.className='phaseBanner'; b.textContent=text; document.body.appendChild(b); setTimeout(()=>b.remove(), 1500); }

    function confettiBurst(){
      const layer=$('confetti'); layer.innerHTML='';
      const colors=['#7dd3fc','#22d3ee','#22c55e','#f59e0b','#ef4444','#a78bfa'];
      for(let i=0;i<60;i++){
        const s=document.createElement('span'); s.textContent=['âœ¨','âœ¦','â˜…','âœ¸','âœº','â‡'][Math.floor(Math.random()*6)];
        s.style.left=Math.random()*100+'%'; s.style.top='-10px'; s.style.color=colors[Math.floor(Math.random()*colors.length)];
        s.style.transform=`translateY(0) rotate(${Math.random()*120}deg)`; s.style.animationDuration= (800+Math.random()*800)+'ms';
        layer.appendChild(s);
      }
      setTimeout(()=>layer.innerHTML='', 1400);
    }

    // ======== Role Reset Helper ========
    function clearRoles(resetMine=false){
      for (const info of players.values()) info.role = null; // quÃªn vai Ä‘Ã£ láº­t
      if (resetMine) setRoleBadge('UNASSIGNED');
      renderPlayers();
    }

    // ======== Players Render ========
    function renderPlayers(){
      playersEl.innerHTML='';
      const names=[...players.keys()].sort((a,b)=>a.localeCompare(b,'vi',{sensitivity:'base'}));
      const aliveNames = names.filter(n=>players.get(n).alive && n!==me);
      // dropdown vote
      const vSel = $('voteTarget');
      vSel.innerHTML = '<option value="">â€” Chá»n ngÆ°á»i Ä‘á»ƒ vote â€”</option>' + aliveNames.map(n=>`<option value="${n}">${n}</option>`).join('');

      for(const name of names){
        const info=players.get(name);
        const wrap=document.createElement('div'); wrap.className='player'+(info.alive?'':' dead');
        const hdr=document.createElement('div'); hdr.className='hdr';

        const av=document.createElement('div'); av.className='avatar'; av.textContent=initials(name);
        const meta=document.createElement('div'); meta.className='meta';
        const nm=document.createElement('div'); nm.className='name'; nm.textContent=name+(name===me?' (Báº¡n)':'');
        const st=document.createElement('div'); st.className='status'; st.textContent= info.alive? 'Äang sá»‘ng':'ÄÃ£ cháº¿t';
        meta.appendChild(nm); meta.appendChild(st);

        const right=document.createElement('div');
        // Chá»‰ hiá»‡n role cá»§a mÃ¬nh; ngÆ°á»i khÃ¡c chá»‰ cÃ³ khi server láº­t vai cuá»‘i vÃ¡n (info.role != null)
        const r = (name===me) ? myRole : (info.role || null);
        if (r){ const badge=document.createElement('div'); badge.className='badge role-'+r; badge.textContent=`${ROLE_ICON[r]||'â“'} ${r}`; right.appendChild(badge); }

        hdr.appendChild(av); hdr.appendChild(meta); hdr.appendChild(right);
        wrap.appendChild(hdr);
        playersEl.appendChild(wrap);
      }
    }

    // ======== WS send helpers ========
    const sendJson = (type, content) => { if (!ws || ws.readyState!==WebSocket.OPEN) return; ws.send(JSON.stringify({type, sender: me, content, timestamp: Date.now()})); };
    const sendRaw  = (line) => { if (!ws || ws.readyState!==WebSocket.OPEN) return; ws.send(line); };

    // ======== Parse lines from SYSTEM ========
    function handleSystemLine(line){
      // RESET_ROLES tá»« server khi báº¯t Ä‘áº§u vÃ¡n má»›i (náº¿u cÃ³)
      if (/^RESET_ROLES\b/i.test(line)){ clearRoles(true); return; }

      if (/\[AUTH_OK\]/.test(line)){ authed=true; $('authCard').style.display='none'; toast('ÄÄƒng nháº­p thÃ nh cÃ´ng'); }

      // PHASE
      const mPhase = /^PHASE:\s*(\w+)/i.exec(line);
      if (mPhase){
        const phase = mPhase[1].toUpperCase();
        setPhase(phase);
      }

      // Tráº­n má»›i â€” reset role (phÃ²ng khi server chÆ°a phÃ¡t RESET_ROLES)
      if (/TrÃ² chÆ¡i Ä‘Ã£ báº¯t Ä‘áº§u/i.test(line)){ clearRoles(true); }

      // Players CSV (alive)
      const mPlayers = /^PLAYERS:\s*(.*)$/i.exec(line);
      if (mPlayers){
        const list=mPlayers[1].split(',').map(s=>s.trim()).filter(Boolean);
        for(const n of list){
          if(!players.has(n)) players.set(n,{alive:true, role:null});
          else players.get(n).alive = true;
        }
        renderPlayers();
      }

      // Dead
      const mDead = /^DEAD:\s*(.+)$/i.exec(line);
      if (mDead){
        const n=mDead[1].trim();
        if(!players.has(n)) players.set(n,{alive:false, role:null});
        players.get(n).alive=false;
        addMsg('â˜ ï¸ '+n+' bá»‹ loáº¡i.','sys');
        renderPlayers();
      }

      // Reveal roles at end
      if (/TrÃ² chÆ¡i káº¿t thÃºc\.|Vai:/i.test(line)){
        const pairs = line.split(':').slice(1).join(':').split(',');
        let any=false;
        for(const raw of pairs){
          const m=/(.+?)â†’\s*([A-Z_]+)/.exec(raw);
          if(m){
            const name=m[1].trim();
            const role=m[2].trim();
            if(!players.has(name)) players.set(name,{alive:true, role:null});
            players.get(name).role=role;
            any=true;
          }
        }
        if(any){ renderPlayers(); confettiBurst(); toast('ğŸ‰ Láº­t vai â€” xem báº£ng ngÆ°á»i chÆ¡i!'); }
      }

      // Role self (cáº£ 2 dáº¡ng: cÃ¢u chá»¯ & marker mÃ¡y-Ä‘á»c)
      const mSelf1 = /Role cá»§a báº¡n:\s*([A-Z_]+)/i.exec(line);
      if(mSelf1){ setRoleBadge(mSelf1[1].toUpperCase()); renderPlayers(); }

      const mSelf2 = /^\[ROLE_SELF\]\s*([A-Z_]+)/.exec(line);
      if(mSelf2){ setRoleBadge(mSelf2[1].toUpperCase()); renderPlayers(); }

      // Joins/Leaves (plain)
      if (/Ä‘Ã£ tham gia phÃ²ng\./i.test(line)){
        const m=/ğŸ‘¤\s*(.+?)\s+Ä‘Ã£ tham gia phÃ²ng\./.exec(line);
        const n=m?m[1].trim():null;
        if(n){ if(!players.has(n)) players.set(n,{alive:true, role:null}); renderPlayers(); toast('ğŸ‘‹ '+n+' vÃ o phÃ²ng'); }
      }
      if (/Ä‘Ã£ rá»i phÃ²ng\./i.test(line)){
        const m=/(.+?)\s+Ä‘Ã£ rá»i phÃ²ng\./.exec(line);
        const n=m?m[1].trim().replace(/^ğŸ“¤\s*/,''):null;
        if(n && players.has(n)){ players.delete(n); renderPlayers(); toast('ğŸ‘‹ '+n+' rá»i phÃ²ng'); }
      }
    }

    // ======== WebSocket wiring ========
    $('btnConnect').onclick = () => {
      const url=$('gw').value.trim(); if(!url) return;
      if(ws && ws.readyState===WebSocket.OPEN){ ws.close(); return; }
      ws = new WebSocket(url);
      ws.addEventListener('open', ()=>{
        setConn(true); addMsg('ğŸ”Œ Connected to '+url,'sys ok'); toast('ÄÃ£ káº¿t ná»‘i Gateway');
        $('btnConnect').textContent='Ngáº¯t káº¿t ná»‘i';
      });
      ws.addEventListener('close', ()=>{
        setConn(false); addMsg('ğŸ”Œ Disconnected','sys err'); toast('Máº¥t káº¿t ná»‘i');
        $('btnConnect').textContent='Káº¿t ná»‘i';
      });
      ws.addEventListener('error', ()=> addMsg('âš ï¸ WS error (xem Network tab náº¿u cáº§n).','sys err'));
      ws.addEventListener('message', (e)=>{
        let m=null; try{ m=JSON.parse(e.data); }catch(_){ /* Bridge Ä‘Ã´i khi gá»­i text thuáº§n */ }
        if(!m || !m.type){ addMsg(String(e.data),'sys'); handleSystemLine(String(e.data)); return; }
        const stamp=new Date(m.timestamp||Date.now()).toLocaleTimeString();
        if(m.type==='SYSTEM'){ addMsg('['+stamp+'] '+m.content,'sys'); handleSystemLine(m.content||''); return; }
        if(m.type==='CHAT'){ const who=(m.sender===me)?'(Báº¡n)':''; addMsg('ğŸ’¬ '+m.sender+who+': '+(m.content||''), m.sender===me?'me':''); return; }
        if(m.type==='JOIN'){
          if(!players.has(m.sender)) players.set(m.sender,{alive:true, role:null});
          addMsg('ğŸ‘‹ '+m.sender+' Ä‘Ã£ vÃ o phÃ²ng','sys ok'); renderPlayers();
          if(m.sender===me){ authed=true; $('authCard').style.display='none'; }
          return;
        }
        if(m.type==='LEAVE'){ if(players.has(m.sender)) players.delete(m.sender); addMsg('ğŸ‘‹ '+m.sender+' Ä‘Ã£ rá»i phÃ²ng','sys'); renderPlayers(); return; }
        addMsg('['+m.type+'] '+(m.content||''), 'sys');
      });
    };

    // ======== Auth ========
    $('btnRegisterLogin').onclick = () => {
      const u=$('regUser').value.trim(), p=$('regPass').value.trim();
      if(!ws || ws.readyState!==WebSocket.OPEN) return alert('ChÆ°a káº¿t ná»‘i Gateway');
      if(!u || !p) return alert('Nháº­p tÃªn & máº­t kháº©u');
      me=u; setYou(me);
      sendRaw(`/register ${u} ${p}`);
      sendRaw(`/login ${u} ${p}`);
    };
    $('btnOnlyLogin').onclick = () => {
      const u=$('regUser').value.trim(), p=$('regPass').value.trim();
      if(!ws || ws.readyState!==WebSocket.OPEN) return alert('ChÆ°a káº¿t ná»‘i Gateway');
      if(!u || !p) return alert('Nháº­p tÃªn & máº­t kháº©u');
      me=u; setYou(me);
      sendRaw(`/login ${u} ${p}`);
    };

    // ======== Chat ========
    $('btnSend').onclick = () => {
      const t=$('msg').value.trim(); if(!t) return;
      if(t.startsWith('/')) sendRaw(t);
      else { sendJson('CHAT',t); addMsg('ğŸ’¬ Báº¡n: '+t,'me'); }
      $('msg').value='';
    };
    $('msg').addEventListener('keydown', e=>{ if(e.key==='Enter') $('btnSend').click(); });

    // ======== Controls ========
    $('btnVote').onclick = () => { const n=$('voteTarget').value; if(!n) return; sendRaw(`/vote ${n}`); addMsg(`ğŸ—³ï¸ Báº¡n vote ${n}`,'me'); };
    $('btnStart').onclick=()=> sendRaw('/start');
    $('btnRematch').onclick=()=> sendRaw('/start');
    $('btnDay').onclick  =()=> sendRaw('/day');
    $('btnNight').onclick=()=> sendRaw('/night');
    $('btnEndDay').onclick=()=> sendRaw('/endday');
    $('btnEndNight').onclick=()=> sendRaw('/endnight');
    $('btnRoleAction').onclick=()=>{
      const t=$('roleTarget').value.trim(); if(!t) return;
      const cmd=({ 'MAFIA':'/kill', 'DOCTOR':'/save', 'DETECTIVE':'/investigate', 'BODYGUARD':'/protect' })[myRole];
      if(!cmd) return alert('Vai cá»§a báº¡n khÃ´ng cÃ³ hÃ nh Ä‘á»™ng trá»±c tiáº¿p.');
      sendRaw(`${cmd} ${t}`); addMsg(`ğŸ§© ${cmd} ${t}`,'me'); $('roleTarget').value='';
    };

    // ======== Boot Defaults ========
    setConn(false); setYou('â€”'); setRoleBadge('UNASSIGNED'); phasePill.textContent='PHASE: LOBBY';
  </script>
</body>
</html>
