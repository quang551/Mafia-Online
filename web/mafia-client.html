<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mafia Online — Web Client</title>
  <style>
    :root{
      --bg: #0b0f14;
      --panel:#0f1520cc;
      --muted:#9aa4ad;
      --text:#e8eef2;
      --brand:#7dd3fc;      /* sky */
      --ok:#22c55e;         /* green */
      --warn:#f59e0b;       /* amber */
      --danger:#ef4444;     /* red  */
      --border:#1e293b;
      --chip:#172233;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#eef2f7; --panel:#ffffffcc; --text:#0e141b; --muted:#516170; --border:#d8e0e7; --chip:#eef3f9; --shadow:0 10px 30px rgba(0,0,0,.08);
      }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font:15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 100% -10%, #0ea5e980 0, transparent 60%),
        radial-gradient(1000px 500px at -10% 110%, #22d3ee66 0, transparent 55%),
        var(--bg);
    }
    .container{
      max-width:1200px; margin:24px auto; padding:0 16px;
      display:flex; gap:16px; align-items:stretch;
      flex-wrap:wrap;
    }
    header{
      width:100%;
      background: linear-gradient(135deg,#0ea5e988,#14b8a688);
      border:1px solid var(--border); border-radius:18px;
      box-shadow:var(--shadow); padding:14px 16px; display:flex; gap:12px; align-items:center; flex-wrap:wrap;
      backdrop-filter:saturate(1.3) blur(8px);
    }
    header h1{font-size:18px; margin:0 8px 0 0; letter-spacing:.3px}
    .pill{padding:6px 10px; border-radius:999px; background:var(--chip); border:1px solid var(--border); color:var(--muted); display:inline-flex; gap:8px; align-items:center}
    .pill.ok{color:#1a2; border-color:#1a2a1f; background:rgba(34,197,94,.12)}
    .pill.bad{color:#a21; border-color:#2a1a1f; background:rgba(239,68,68,.12)}
    .grow{flex:1}
    input,select,button,textarea{
      border-radius:12px; border:1px solid var(--border); padding:10px 12px; background:var(--panel); color:var(--text);
      outline:none; transition:.15s border-color ease; font:inherit;
    }
    input::placeholder, textarea::placeholder{color:var(--muted)}
    input:focus,textarea:focus,select:focus{border-color:#38bdf8}
    button{cursor:pointer; user-select:none;}
    .btn{background:#0ea5e9; border-color:#0284c7; color:#031016; font-weight:600}
    .btn.ghost{background:var(--chip); color:var(--text)}
    .btn.warn{background:#f59e0b; border-color:#b45309; color:#2b1600}
    .btn.danger{background:#ef4444; border-color:#991b1b; color:#2b0a0a}
    .stack{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .card{
      background:var(--panel); border:1px solid var(--border); border-radius:18px; box-shadow:var(--shadow); overflow:hidden;
      backdrop-filter:saturate(1.3) blur(8px);
    }

    /* Layout */
    .left{flex:1 1 620px; display:flex; flex-direction:column; gap:12px}
    .right{flex:1 1 380px; display:flex; flex-direction:column; gap:12px}

    /* Auth */
    .auth{padding:14px}
    .auth .row{display:flex; gap:8px; flex-wrap:wrap}
    .auth .row > *{flex:1 1 160px}
    .auth .row .btn{flex:0 0 auto}

    /* Chat */
    .chat{display:flex; flex-direction:column; height:540px}
    .log{flex:1; padding:14px; overflow:auto}
    .log .msg{padding:8px 10px; border-radius:12px; margin:6px 0; border:1px solid var(--border); background:rgba(255,255,255,0.02)}
    .log .me{border-color:#10b98166; background:rgba(16,185,129,.1)}
    .log .sys{border-style:dashed; opacity:.9}
    .log .ok{border-color:#22c55e66; background:rgba(34,197,94,.08)}
    .log .err{border-color:#ef444466; background:rgba(239,68,68,.08)}
    .composer{display:flex; gap:8px; padding:12px; border-top:1px solid var(--border)}
    .composer input{flex:1}

    /* Players */
    .panel{padding:12px}
    .players{display:flex; flex-direction:column; gap:10px; max-height:540px; overflow:auto}
    .player{
      display:flex; align-items:center; gap:10px; border:1px solid var(--border); padding:10px; border-radius:14px; background:rgba(255,255,255,0.03)
    }
    .avatar{
      width:36px; height:36px; border-radius:50%; background:linear-gradient(135deg,#38bdf8,#14b8a6); display:grid; place-items:center;
      color:#031016; font-weight:800;
      border:1px solid #0ea5e955;
    }
    .meta{display:flex; flex-direction:column; gap:2px; flex:1}
    .name{font-weight:700}
    .dead .name{text-decoration:line-through; color:#94a3b8}
    .status{font-size:12px; color:var(--muted)}
    .badge{
      padding:4px 7px; border-radius:999px; font-size:12px; font-weight:700; border:1px solid var(--border); background:var(--chip); color:var(--text);
      display:inline-flex; gap:6px; align-items:center; white-space:nowrap;
    }
    .role-MAFIA{background:rgba(239,68,68,.12); border-color:#7f1d1d; color:#fecaca}
    .role-DOCTOR{background:rgba(34,197,94,.12); border-color:#14532d; color:#bbf7d0}
    .role-DETECTIVE{background:rgba(59,130,246,.12); border-color:#1e3a8a; color:#bfdbfe}
    .role-BODYGUARD{background:rgba(99,102,241,.12); border-color:#3730a3; color:#c7d2fe}
    .role-JESTER{background:rgba(245,158,11,.12); border-color:#7c2d12; color:#fde68a}
    .role-VILLAGER{background:rgba(14,165,233,.12); border-color:#075985; color:#bae6fd}
    .role-UNASSIGNED{background:rgba(148,163,184,.15); border-color:#334155; color:#e2e8f0}

    .section-title{margin:0 0 8px 0; font-weight:800; letter-spacing:.3px}
    .controls .row{display:flex; gap:8px; flex-wrap:wrap}
    .controls .row > *{flex:1 1 120px}
    .small{font-size:12px; color:var(--muted)}
    .sep{height:1px; background:var(--border); margin:10px 0}
  </style>
</head>
<body>
  <div class="container">
    <header class="card">
      <h1>🎭 Mafia Online</h1>
      <div class="pill" id="phasePill">PHASE: LOBBY</div>
      <div class="pill" id="youPill">Bạn: <span id="youName">—</span> <span class="badge role-UNASSIGNED" id="youRole"><span>❓</span> UNASSIGNED</span></div>
      <div class="grow"></div>
      <input id="gw" placeholder="ws://localhost:8080/ws" value="ws://localhost:8080/ws" />
      <button class="btn" id="btnConnect">Kết nối</button>
      <div id="conn" class="pill bad">Disconnected</div>
    </header>

    <!-- AUTH -->
    <section class="left card auth" id="authCard">
      <div class="stack" style="justify-content:space-between">
        <div class="section-title">🔐 Đăng ký & Đăng nhập</div>
        <div class="small">Lưu ý: mật khẩu gửi plaintext trong LAN</div>
      </div>
      <div class="row" style="margin-top:6px">
        <input id="regUser" placeholder="Tên đăng ký (vd. alice)" />
        <input id="regPass" placeholder="Mật khẩu" type="password" />
        <button class="btn" id="btnRegisterLogin">Đăng ký & Đăng nhập</button>
        <button class="btn ghost" id="btnOnlyLogin">Chỉ Đăng nhập</button>
      </div>
      <div class="small">Hoặc gõ trực tiếp: <code>/register &lt;u&gt; &lt;p&gt;</code>, <code>/login &lt;u&gt; &lt;p&gt;</code> trong ô chat.</div>
    </section>

    <!-- CHAT -->
    <section class="left card chat">
      <div class="log" id="log"></div>
      <div class="composer">
        <input id="msg" placeholder="Gõ tin nhắn hoặc /lệnh (ví dụ: /vote bob)" />
        <button class="btn" id="btnSend">Gửi</button>
      </div>
    </section>

    <!-- RIGHT -->
    <aside class="right">
      <section class="card panel">
        <div class="section-title">👥 Người chơi</div>
        <div class="players" id="players"></div>
      </section>

      <section class="card panel controls">
        <div class="section-title">🛠️ Điều khiển nhanh</div>
        <div class="row">
          <select id="voteTarget"></select>
          <button class="btn" id="btnVote">Vote</button>
          <button class="btn ghost" id="btnStart">Start Game</button>
          <button class="btn ghost" id="btnDay">Day</button>
          <button class="btn ghost" id="btnNight">Night</button>
          <button class="btn warn" id="btnEndDay">End Day</button>
          <button class="btn warn" id="btnEndNight">End Night</button>
        </div>
        <div class="sep"></div>
        <div class="row">
          <input id="roleTarget" placeholder="Tên mục tiêu theo vai (kill/save/...)" />
          <button class="btn danger" id="btnRoleAction">Thực hiện</button>
        </div>
        <div class="small">Mafia: <code>/kill tên</code> • Doctor: <code>/save tên</code> • Detective: <code>/investigate tên</code> • Bodyguard: <code>/protect tên</code></div>
      </section>
    </aside>
  </div>

  <script>
    /* ========= State ========= */
    let ws = null;
    let me = null;
    let authed = false;
    let myRole = 'UNASSIGNED';
    const players = new Map(); // name -> {alive:true, role:null|'MAFIA'...}

    const el = id => document.getElementById(id);
    const logEl = el('log'), playersEl = el('players'), phasePill = el('phasePill'), youPill = el('youPill'), youName = el('youName'), youRole = el('youRole');

    const ROLE_ICON = {
      MAFIA:'🕴️', DOCTOR:'🩺', DETECTIVE:'🕵️‍♂️', BODYGUARD:'🛡️', JESTER:'🤡', VILLAGER:'🧑‍🌾', UNASSIGNED:'❓'
    };

    /* ========= UI helpers ========= */
    function addMsg(text, cls=''){
      const div = document.createElement('div');
      div.className = 'msg ' + cls;
      div.textContent = text;
      logEl.appendChild(div);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function setConn(ok){
      const c = el('conn');
      c.textContent = ok ? 'Connected' : 'Disconnected';
      c.className = 'pill ' + (ok ? 'ok' : 'bad');
    }

    function setPhase(phase){
      phasePill.textContent = 'PHASE: ' + phase;
    }

    function setYou(name){
      youName.textContent = name || '—';
    }

    function setRoleBadge(role){
      myRole = role || 'UNASSIGNED';
      youRole.className = 'badge role-' + myRole;
      youRole.innerHTML = `<span>${ROLE_ICON[myRole] || '❓'}</span> ${myRole}`;
    }

    function initials(name){
      const p = (name||'').split(/\s+/).filter(Boolean);
      return (p[0]?.[0] || '?').toUpperCase() + (p[1]?.[0]||'');
    }

    function renderPlayers(){
      playersEl.innerHTML = '';
      const names = [...players.keys()].sort((a,b)=>a.localeCompare(b,'vi',{sensitivity:'base'}));
      const aliveNames = names.filter(n=>players.get(n).alive);
      // build dropdown Vote
      const vSel = el('voteTarget');
      vSel.innerHTML = '<option value="">— Chọn người để vote —</option>' + aliveNames.map(n=>`<option value="${n}">${n}</option>`).join('');

      for(const name of names){
        const info = players.get(name);
        const wrap = document.createElement('div');
        wrap.className = 'player' + (info.alive ? '' : ' dead');

        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        avatar.textContent = initials(name);

        const meta = document.createElement('div');
        meta.className = 'meta';
        const nm = document.createElement('div');
        nm.className = 'name';
        nm.textContent = name + (name===me ? ' (Bạn)' : '');
        const st = document.createElement('div');
        st.className = 'status';
        st.textContent = info.alive ? 'Đang sống' : 'Đã chết';

        meta.appendChild(nm); meta.appendChild(st);

        const right = document.createElement('div');
        // Chỉ hiển thị badge role nếu đã reveal (info.role)
        const badge = document.createElement('div');
        const r = info.role || (name===me ? myRole : null);
        if(r){
          badge.className = 'badge role-' + r;
          badge.innerHTML = `<span>${ROLE_ICON[r]||'❓'}</span> ${r}`;
          right.appendChild(badge);
        }

        wrap.appendChild(avatar);
        wrap.appendChild(meta);
        wrap.appendChild(right);
        playersEl.appendChild(wrap);
      }
    }

    /* ========= WS send ========= */
    const sendJson = (type, content) => {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      ws.send(JSON.stringify({type, sender: me, content, timestamp: Date.now()}));
    };
    const sendRaw = line => { if (ws && ws.readyState === WebSocket.OPEN) ws.send(line); }; // QUAN TRỌNG: lệnh /register, /login

    /* ========= Parse server lines ========= */
    function handleSystemLine(line){
      // Phát hiện AUTH_OK
      if (/\[AUTH_OK\]/.test(line)){
        authed = true;
        el('authCard').style.display = 'none';
        addMsg('✅ '+ line, 'ok sys');
      }

      // PLAYERS: a, b, c
      const mPlayers = /^PLAYERS:\s*(.*)$/i.exec(line);
      if (mPlayers){
        const list = mPlayers[1].split(',').map(s=>s.trim()).filter(Boolean);
        // Nếu danh sách trống, vẫn giữ map (có thể lobby reset)
        for(const n of list){
          if (!players.has(n)) players.set(n, {alive:true, role:null});
          else players.get(n).alive = true;
        }
        // Mark những người không có trong list là dead (khi END -> reset sẽ set alive=true sau)
        for(const k of [...players.keys()]){
          if (!list.includes(k)) {
            // Chỉ đánh dấu chết nếu game đang chạy; lobby có thể khác
            // để đơn giản, giữ nguyên trạng thái
          }
        }
        renderPlayers();
      }

      // DEAD: name
      const mDead = /^DEAD:\s*(.+)$/i.exec(line);
      if (mDead){
        const n = mDead[1].trim();
        if (!players.has(n)) players.set(n, {alive:false, role:null});
        players.get(n).alive = false;
        addMsg('☠️ ' + n + ' bị loại.', 'sys');
        renderPlayers();
      }

      // PHASE: ...
      const mPhase = /^PHASE:\s*(\w+)/i.exec(line);
      if (mPhase){
        setPhase(mPhase[1].toUpperCase());
      }

      // Vai: A → ROLE, B → ROLE ...
      if (/Trò chơi kết thúc\.\s*Vai:/i.test(line) || /Vai:\s*/i.test(line)){
        // ví dụ: "Vai: Alice → MAFIA, Bob → VILLAGER"
        const pairs = line.split(':').slice(1).join(':').split(',');
        for(const raw of pairs){
          const m = /(.+?)→\s*([A-Z_]+)/.exec(raw);
          if (m){
            const name = m[1].trim();
            const role = m[2].trim();
            if (!players.has(name)) players.set(name,{alive:true,role:null});
            players.get(name).role = role;
          }
        }
        renderPlayers();
      }

      // Role cá nhân: "🎭 Role của bạn: ROLE — ..."
      const mSelf = /Role của bạn:\s*([A-Z_]+)/i.exec(line);
      if (mSelf){
        setRoleBadge(mSelf[1].toUpperCase());
        renderPlayers();
      }

      // JOIN/LEAVE (text thuần)
      if (/đã tham gia phòng\./i.test(line)){
        const m = /👤\s*(.+?)\s+đã tham gia phòng\./.exec(line);
        const n = m ? m[1].trim() : null;
        if (n){
          if (!players.has(n)) players.set(n,{alive:true, role:null});
          renderPlayers();
        }
      }
      if (/đã rời phòng\./i.test(line)){
        const m = /(.+?)\s+đã rời phòng\./.exec(line);
        const n = m ? m[1].trim().replace(/^📤\s*/,'') : null;
        if (n && players.has(n)){
          players.delete(n);
          renderPlayers();
        }
      }
    }

    /* ========= WS wiring ========= */
    el('btnConnect').onclick = () => {
      const url = el('gw').value.trim();
      if (!url) return;
      if (ws && ws.readyState === WebSocket.OPEN){ ws.close(); return; }

      ws = new WebSocket(url);
      ws.addEventListener('open', () => { setConn(true); addMsg('🔌 Connected to '+url, 'sys ok'); });
      ws.addEventListener('close', () => { setConn(false); addMsg('🔌 Disconnected', 'sys err'); });
      ws.addEventListener('error', () => addMsg('⚠️ WS error (xem Network tab nếu cần).','sys err'));
      ws.addEventListener('message', (e) => {
        // Bridge gửi JSON {type, sender, content, timestamp}
        let m = null;
        try{ m = JSON.parse(e.data); }catch(_){}
        if (!m || !m.type){ addMsg(String(e.data),'sys'); return; }

        // Mirror log đẹp mắt
        const stamp = new Date(m.timestamp||Date.now()).toLocaleTimeString();
        if (m.type === 'SYSTEM'){
          addMsg('['+stamp+'] ' + m.content, 'sys');
          handleSystemLine(m.content||'');
          return;
        }
        if (m.type === 'CHAT'){
          const who = (m.sender===me) ? '(Bạn)' : '';
          addMsg('💬 '+ m.sender + who + ': ' + (m.content||''), m.sender===me?'me':'');
          return;
        }
        if (m.type === 'JOIN'){
          if (!players.has(m.sender)) players.set(m.sender, {alive:true, role:null});
          addMsg('👋 '+ m.sender + ' đã vào phòng', 'sys ok');
          renderPlayers();
          // Nếu là chính mình (sau AUTH_OK), ẩn khối auth
          if (m.sender === me){ authed = true; el('authCard').style.display='none'; }
          return;
        }
        if (m.type === 'LEAVE'){
          if (players.has(m.sender)) players.delete(m.sender);
          addMsg('👋 '+ m.sender + ' đã rời phòng', 'sys');
          renderPlayers();
          return;
        }
        // Các type khác
        addMsg('['+m.type+'] ' + (m.content||''), 'sys');
      });
    };

    /* ========= Auth buttons ========= */
    el('btnRegisterLogin').onclick = () => {
      const u = el('regUser').value.trim();
      const p = el('regPass').value.trim();
      if (!ws || ws.readyState !== WebSocket.OPEN) return alert('Chưa kết nối Gateway');
      if (!u || !p) return alert('Nhập tên & mật khẩu');

      me = u; setYou(me);
      sendRaw(`/register ${u} ${p}`);
      sendRaw(`/login ${u} ${p}`);
    };
    el('btnOnlyLogin').onclick = () => {
      const u = el('regUser').value.trim();
      const p = el('regPass').value.trim();
      if (!ws || ws.readyState !== WebSocket.OPEN) return alert('Chưa kết nối Gateway');
      if (!u || !p) return alert('Nhập tên & mật khẩu');
      me = u; setYou(me);
      sendRaw(`/login ${u} ${p}`);
    };

    /* ========= Chat composer ========= */
    el('btnSend').onclick = () => {
      const t = el('msg').value.trim();
      if (!t) return;
      if (t.startsWith('/')) sendRaw(t); else sendJson('CHAT', t);
      if (!t.startsWith('/')) addMsg('💬 Bạn: ' + t, 'me');
      el('msg').value = '';
    };
    el('msg').addEventListener('keydown', (e)=>{
      if (e.key === 'Enter') el('btnSend').click();
    });

    /* ========= Controls ========= */
    el('btnVote').onclick = () => {
      const n = el('voteTarget').value;
      if (!n) return;
      sendRaw(`/vote ${n}`);
      addMsg(`🗳️ Bạn vote ${n}`, 'me');
    };
    el('btnStart').onclick = () => sendRaw('/start');
    el('btnDay').onclick = () => sendRaw('/day');
    el('btnNight').onclick = () => sendRaw('/night');
    el('btnEndDay').onclick = () => sendRaw('/endday');
    el('btnEndNight').onclick = () => sendRaw('/endnight');

    el('btnRoleAction').onclick = () => {
      const t = el('roleTarget').value.trim();
      if (!t) return;
      const cmd = ({
        'MAFIA':'/kill',
        'DOCTOR':'/save',
        'DETECTIVE':'/investigate',
        'BODYGUARD':'/protect'
      })[myRole];
      if (!cmd) return alert('Vai của bạn không có hành động trực tiếp.');
      sendRaw(`${cmd} ${t}`);
      addMsg(`🧩 ${cmd} ${t}`, 'me');
      el('roleTarget').value = '';
    };

    /* ========= Boot ========= */
    setConn(false);
    setYou('—');
    setRoleBadge('UNASSIGNED');
    setPhase('LOBBY');
  </script>
</body>
</html>
